<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">

<head>
	<meta charset="UTF-8">
	<title>empList.html</title>

</head>

<body>
	<section layout:fragment="content">
		<h2>사원 관리</h2>
		<div>
			<button class="btn btn-secondary" style="float: right; margin: 8px 5px;" id="empInsert">저장</button>
			<button class="btn btn-secondary" style="float: right; margin: 8px 5px;" onclick="addRow()">추가</button>
		</div>
		<div id="grid"></div>

		<script th:inline="javascript">
			function addRow() {
				grid.appendRow({isNew: true});

				// 마지막 행의 데이터를 콘솔에 출력
				const lastRowId = grid.getRowCount() - 1;
				const lastRowData = grid.getRow(lastRowId);
				console.log('새로 추가된 행 데이터:', lastRowData);
			}

			function onBeforeChange(ev) {
				const {rowKey} = ev.changes[0];

				// TOAST UI Grid의 getRow 메소드를 사용하여 현재 행의 데이터를 가져옵니다.
				const row = grid.getRow(rowKey);

				// 현재 행의 데이터를 콘솔에 출력
				console.log('편집 시도 행 데이터:', row);

				// isNew 속성이 true가 아니면 편집을 중단합니다.
				if (!row || row.isNew !== true) {
					ev.stop(); // 이 메소드는 편집을 취소합니다.
				}
			}

			function onAfterChange(ev) {
				console.log('편집 완료 이벤트:', ev);
				// 필요한 경우, 여기에서 데이터 업데이트 로직을 구현할 수 있습니다.
			}






			let emps = [[${list}]]
			console.log(emps);
			const authorityOptions = [
				{text: '관리자', value: 'admin'},
				{text: '일반사원', value: 'user'},
				// 추가적인 옵션...
			];

			// TOAST UI Grid 초기화
			const grid = new tui.Grid({



				el: document.getElementById('grid'),
				data: emps, // 여기서 emps 데이터를 사용
				scrollX: false,
				scrollY: false,
				columns: [
					{header: '사원 번호', name: 'userCode'},
					{
						header: '이름', name: 'userName',
						editor: 'text'

					},
					{
						header: '부서명', name: 'deptName',
						editor: {
							type: 'select',
							options: {
								listItems: [
									{text: '생산', value: 'prod'},
									{text: '설비', value: 'fac'},
									{text: '영업', value: 'sal'},
									{text: '자재', value: 'mat'},

								]
							}
						},
						formatter: function ({value}) {
							if (value == 'prod') {
								return '생산';
							}
							if (value == 'fac') {
								return '설비';
							}
							if (value == 'sal') {
								return '영업';
							}
							if (value == 'mat') {
								return '자재';
							}
							return value;
						}
					},
					{header: '이메일', name: 'userEmail', editor: 'text'},
					{header: '연락처', name: 'userPhone', editor: 'text'},
					{
						header: '직급', name: 'userAuthority',
						editor: {
							type: 'select',
							options: {
								listItems: [
									{text: '관리자', value: 'admin'},
									{text: '일반사원', value: 'user'},
									// 추가적인 옵션...
								] // 위에서 정의한 옵션 목록 사용
							}
						},
						formatter: function ({value}) {
							if (value == 'admin') {
								return '관리자';
							}
							if (value == 'user') {
								return '일반사원';
							}
							return value;
						}
					},

				],
				rowHeaders: ['rowNum'],
				pageOptions: {
					useClient: true,
					perPage: 5
				}
			});
			grid.on('beforeChange', onBeforeChange);
			//grid.on('afterChange', onAfterChange);




		</script>
		<script>
			function convertDeptNameToCode(deptName) {
				const deptNameToCodeMapping = {
					'fac': 'dept001',
					'prod': 'dept002',
					'sal': 'dept003',
					'mat': 'dept004'
					// 여기에 더 많은 매핑을 추가할 수 있습니다.
				};

				return deptNameToCodeMapping[deptName] || deptName; // 매핑된 코드가 없다면 원래의 deptName을 반환
			}

			function saveNewRows() {
				// 새로 추가된 행만 필터링하여 가져옵니다.
				const newData = grid.getData().filter(row => row.isNew);

				// 콘솔에 출력하거나 서버로 보낼 수 있습니다.
				console.log('추가된 행의 데이터:', newData);

				// 서버에 데이터를 전송하는 코드를 여기에 추가합니다.
				// 예: AJAX 요청을 사용하여 서버에 'newData'를 전송합니다.
				console.log("부서이름 : ", newData[0].deptName);

				newData.forEach(row => {
					row.deptCode = convertDeptNameToCode(row.deptName);
				});
				
				console.log("부서 code : ", newData[0].deptCode);
				
				let data = {};
				data.userName = newData[0].userName;
				data.userEmail = newData[0].userEmail;
				data.deptCode = newData[0].deptCode;
				data.userPhone = newData[0].userPhone;
				data.userAuthority = newData[0].userAuthority;
				
				console.log('data : ', data);
				
				fetch('/empInsert', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',

					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.text();
					})
					.then(data => {
						console.log('Success:', data);
						alert(data);
						location.href = '/empList'; // 성공적으로 처리된 후 리디렉트
					})
					.catch(error => {
						console.error('Error:', error);
					});
			}

			// "저장" 버튼에 이벤트 리스너를 등록합니다.
			document.getElementById('empInsert').addEventListener('click', saveNewRows);

		</script>

	</section>

</body>

</html>