<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">

<head>
	<meta charset="UTF-8">
	<title>empList.html</title>

</head>

<body>
	<section layout:fragment="content" class="m-5">
		<h2>제품 관리</h2>
		<br>
		<div>
			<button class="btn btn-secondary" style="float: right; margin: 8px 5px;" id="procInsert">저장</button>
			<button class="btn btn-secondary" style="float: right; margin: 8px 5px;" onclick="addRow()">추가</button>
		</div>
		<div id="grid"></div>

		<script th:inline="javascript">
			function addRow() {
				grid.prependRow({isNew: true});

				// 마지막 행의 데이터를 콘솔에 출력
				const lastRowId = grid.getRowCount() - 1;
				const lastRowData = grid.getRow(lastRowId);
				console.log('새로 추가된 행 데이터:', lastRowData);
			}

			function onBeforeChange(ev) {
				const {rowKey} = ev.changes[0];

				// TOAST UI Grid의 getRow 메소드를 사용하여 현재 행의 데이터를 가져옵니다.
				const row = grid.getRow(rowKey);

				// 현재 행의 데이터를 콘솔에 출력
				console.log('편집 시도 행 데이터:', row);

				// isNew 속성이 true가 아니면 편집을 중단합니다.
				if (!row || row.isNew !== true) {
					ev.stop(); // 이 메소드는 편집을 취소합니다.
				}
			}

			function onAfterChange(ev) {
				console.log('편집 완료 이벤트:', ev);
				// 필요한 경우, 여기에서 데이터 업데이트 로직을 구현할 수 있습니다.
			}






			let emps = [[${list}]]
			console.log(emps);
			

			// TOAST UI Grid 초기화
			const grid = new tui.Grid({



				el: document.getElementById('grid'),
				data: emps, // 여기서 emps 데이터를 사용
				scrollX: false,
				scrollY: false,
				columns: [
					{header: '공정 코드', name: 'procCode'},
					{
						header: '공정 명', name: 'procName',
						editor: 'text'

					},
					{header: '등록일', name: 'procDate',
						formatter: function ({value}) {
							if (value) {
								var date = new Date(value);
								var year = date.getFullYear();
								var month = (date.getMonth() + 1).toString().padStart(2, '0');
								var day = date.getDate().toString().padStart(2, '0');
								return `${year}-${month}-${day}`;
							}
							return '';
						}
					}
					

				],
				rowHeaders: ['rowNum'],
				pageOptions: {
					useClient: true,
					perPage: 5
				}
			});
			grid.on('beforeChange', onBeforeChange);
			//grid.on('afterChange', onAfterChange);

		</script>
		<script>
			

			function saveNewRows() {
				// 새로 추가된 행만 필터링하여 가져옵니다.
				const newData = grid.getData().filter(row => row.isNew);

				if (newData.length === 0) {
					console.log('추가된 행이 없습니다.');
					alert("저장 할 데이터가 없습니다.");
					return;
				}
				// 콘솔에 출력하거나 서버로 보낼 수 있습니다.
				console.log('추가된 행의 데이터:', newData);

				// 서버에 데이터를 전송하는 코드를 여기에 추가합니다.
				// 예: AJAX 요청을 사용하여 서버에 'newData'를 전송합니다.
				

				

				

				let data = {};
				data.procName = newData[0].procName;
				
				

				console.log('data : ', data);

				fetch('/procInsert', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',

					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.text();
					})
					.then(data => {
						console.log('Success:', data);
						alert(data);
						location.href = '/procList'; // 성공적으로 처리된 후 리디렉트
					})
					.catch(error => {
						console.error('Error:', error);
					});
			}

			// "저장" 버튼에 이벤트 리스너를 등록합니다.
			document.getElementById('procInsert').addEventListener('click', saveNewRows);

		</script>

	</section>

</body>

</html>