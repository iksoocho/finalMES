<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<style>
input {
	padding-left: 10px;
}

th {
	background-color: rgba(250, 250, 250);
}

.containerOne {
	margin: 20px;
	text-align: center;
}

.containerTwo {
	margin-top: 20px;
}

table {
	width: 100%;
}

h4 {
	text-align: left;
}

tr {
	height: 42px;
}

input[type=text], input[type=date], select {
	width: 90%;
}

input[type=number] {
	width: 60%;
}

.orderInfoOne th {
	border: solid 1px gray;
	text-align: center;
	width: 156px;
}

.orderInfoOne td, .orderInfoTwo td {
	border: solid 1px gray;
	width: 500px;
}

.orderInfoTwo {
	margin-top: 10px;
	border: solid 1px gray;
}

.orderInfoTwo th {
	border: solid 1px gray;
	width: 156px;
}

.moreInfo, .moreInfo th, .moreInfo td, .orderInfoOne {
	border: solid 1px gray;
}

.ttlCount {
	text-align: right;
	padding-right: 10px;
}

h5 {
	display: inline-block;
	float: left;
	margin-top: 8px;
}

button {
	float: right;
	margin-right: 5px;
	margin-bottom: 10px;
}

.space {
	height: 10px;
	border: solid 1px #fff;
}

.numberOne, .numberTwo, .numberThree {
	text-align: right;
	padding-right: 10px;
}

.containerThree {
	margin-top: 30px;
}

.red {
	color: red;
}

.serch {
	padding-left: 11px;
	padding-right: 22px;
}

.serch input {
	margin-top: 1px;
	width: 40%;
	background-color: rgba(250, 250, 250);
	border: solid 1px gray;
	border-radius: 2px;
}

.serch button {
	margin: 0px;
	width: 50px;
	height: 30px;
}

.serch p {
	font-size: 12px;
}

.readInput {
	background-color: rgba(250, 250, 250);
	border: solid 1px gray;
	border-radius: 2px;
}

.modal-body ul {
	list-style-type: none;
	padding: 0;
	margin: 0;
	width: 100%;
	position: relative;
}

.modal-body td {
	border-bottom: solid 1px rgba(220, 220, 220);
	cursor: pointer;
}

.modal-body hr {
	margin: 0;
}

/* 그리드 스타일 */
.subTitle {
	display: inline-block;
}
</style>
<meta charset="UTF-8">
<title>출고관리</title>
</head>
<body>
	<section layout:fragment="content">
		<div class="containerOne">
			<h4>출고 관리</h4>
			<div class="containerTwo">
				<h5>출고서정보</h5>
				<button class="btn btn-primary" onclick="resetForm()">초기화</button>
				<button class="btn btn-primary" onclick="saveOrder()">등록</button>
				<table class="orderInfoOne">
					<tr>
						<th>출고서번호</th>
						<td><input class="readInput" type="text" id="" name="" placeholder="시스템 자동발번" readonly></td>
						<th>등록일</th>
						<td><input type="date" id="registrationDate" name="" readonly></td>
						<th>출고서상태</th>
						<td><select id="ordState" name="">
								<option value="0" selected>등록전
								<option value="1" disabled>등록완료
								<option value="2" disabled>출고 대기 중
								<option value="3" disabled>출고중
								<option value="4" disabled>출고 완료
								<option value="5" disabled>도착 완료
						</select></td>
					</tr>
					<tr>
						<th class="red">담당자</th>
						<td class="serch"><input type="text" readonly> <input type="text" id="ordManager" name="">

							<button type="button" class="btn btn-primary">
								<p>검색</p>
							</button></td>
						<th>담당자 연락처</th>
						<td><input class="readInput" type="text" readonly></td>
						<td colspan="2"></td>
					</tr>
					<tr class="space"></tr>
					<tr>
						<th class="red">거래처</th>
						<td class="serch"><input type="text" id="selectedBusinessCode" name="businessCode" readonly> <input type="text" id="selectedBusinessName" readonly>
							<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdropBusiness">
								<p>검색</p>
							</button></td>
						<th>거래처 담당자</th>
						<td><input class="readInput" type="text" id="selectedBusinessManager" readonly></td>
						<th>거래처 연락처</th>
						<td><input class="readInput" type="text" id="selectedBusinessManagerPhone" readonly></td>
					</tr>
					<tr>
						<th>비고</th>
						<td><input type="text" name="" id=""></td>
					</tr>
				</table>
			</div>
		</div>
		<div class=containerOne>
			<h5>상세정보</h5>
			<button class="btn btn-primary">취소</button>
			<button class="btn btn-primary">추가</button>
			<button class="btn btn-success">재고현황 불러오기</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#staticBackdropOrd">주문서 불러오기</button>
		</div>
		<div id="grid" class="containerOne"></div>



		<!-- 거래처 모달 -->
		<div class="modal fade" id="staticBackdropBusiness" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header" style="background-color: #0d6efd;">
						<h1 class="modal-title fs-5" id="staticBackdropLabel" style="font-weight: bold">거래처 목록</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<div class="modal-body">

						<table>
							<thead style="text-align: center;">
								<tr>
									<th>거래처코드</th>
									<th>거래처명</th>
								</tr>
							</thead>
							<tbody style="text-align: center;">
								<tr th:each="business : ${businessList}" th:data-businessCode="${business.businessCode}" th:data-businessName="${business.businessName}" th:data-businessManager="${business.businessManager}"
									th:data-businessManagerPhone="${business.businessManagerPhone}" data-bs-dismiss="modal" onclick="updateInputFields(this)">
									<td th:text="${business.businessCode}"></td>
									<td th:text="${business.businessName}"></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="modal-footer" style="background-color: #0d6efd;">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>

					</div>
				</div>
			</div>
		</div>

		<!-- 주문서 모달 -->
		<div class="modal fade modal-xl" id="staticBackdropOrd" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header" style="background-color: #ffc107;">
						<h1 class="modal-title fs-5" id="staticBackdropLabel" style="font-weight: bold">주문서 목록</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<div class="modal-body">
						<table>
							<thead style="text-align: center;">
								<tr>
									<th>주문서 번호</th>
									<th>상태</th>
									<th>거래처</th>
									<th>등록일</th>
									<th>담당자</th>
									<th>총금액</th>
									<th>비고</th>
								</tr>
							</thead>
							<tbody style="text-align: center;">
								<tr th:each="ord : ${orderList}" th:data-ordCode="${ord.ordCode}" th:data-ordState="${ord.ordState}" th:data-businessCode="${ord.businessCode}" th:data-ordDate="${ord.ordDate}"
									th:data-ordManager="${ord.ordManager}" th:data-totalTtlPrice="${ord.totalTtlPrice}" th:data-ordNote="${ord.ordNote}" data-bs-dismiss="modal" th:onclick="'displaySelectedProduct(this)'">
									<td th:text="${ord.ordCode}"></td>
									<td th:text="${ord.ordState == 1 ? '등록완료' : (ord.ordState == 2 ? '처리중' : (ord.ordState == 3 ? '종결' : '기타'))}"></td>
									<td th:text="${ord.businessCode}"></td>
									<td th:text="${#dates.format(ord.ordDate, 'yyyy-MM-dd')}"></td>
									<td th:text="${ord.ordManager}"></td>
									<td th:text="|${#numbers.formatInteger(ord.totalTtlPrice, 0, 'COMMA')} 원|" style="text-align: right;"></td>
									<td th:text="${ord.ordNote}" style="text-align: left; padding-left: 30px;"></td>
								</tr>
							</tbody>
						</table>

					</div>
					<div class="modal-footer" style="background-color: #ffc107;">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>

					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
			/* 토스트 그리드 */

			let grid = tui.Grid;
			grid.applyTheme('clean', {
				row : {
					hover : {
						background : '#d4e9f2'
					}
				}
			});

			grid = new tui.Grid({
				el : document.getElementById('grid'),
				scrollX : false,
				scrollY : false,
				rowHeaders : [ 'rowNum', 'checkbox' ],
				columns : [ {
					header : '품목명',
					name : '',

				}, {
					header : '단위',
					name : '',

				}, {
					header : 'LOT',
					name : '',
				}, {
					header : '현재고',
					name : '',
				}, {
					header : '수량',
					name : '',
				}, {
					header : '단가',
					name : '',
				}, {
					header : '총금액',
					name : '',
				}, ],

			});

			document
					.addEventListener(
							'DOMContentLoaded',
							function() {
								// 현재 날짜를 가져오는 함수 호출
								var currentDate = getCurrentDate();
								// 입력 필드에 현재 날짜 설정
								document.getElementById('registrationDate').value = currentDate;
							});

			// 현재 날짜를 반환하는 함수
			function getCurrentDate() {
				var today = new Date();
				var year = today.getFullYear();
				var month = ('0' + (today.getMonth() + 1)).slice(-2); // 0을 추가해서 두 자리로 만듦
				var day = ('0' + today.getDate()).slice(-2); // 0을 추가해서 두 자리로 만듦
				return year + '-' + month + '-' + day;
			}

			// 모달창에서 거래처 클릭시 input태그에 채워주는 기능
			function updateInputFields(liElement) {
				// 클릭한 <li> 요소에서 데이터 속성을 가져옴
				var businessCode = liElement.getAttribute('data-businessCode');
				var businessName = liElement.getAttribute('data-businessName');
				var businessManager = liElement
						.getAttribute('data-businessManager');
				var businessManagerPhone = liElement
						.getAttribute('data-businessManagerPhone');

				// 입력 필드의 값 설정
				document.getElementById('selectedBusinessCode').value = businessCode;
				document.getElementById('selectedBusinessName').value = businessName;
				document.getElementById('selectedBusinessManager').value = businessManager;
				document.getElementById('selectedBusinessManagerPhone').value = businessManagerPhone;

			}
			
			function displaySelectedProduct(element) {
			    // 선택된 주문서의 정보를 가져옴
			    var ordCode = element.getAttribute('data-ordCode');
				console.log(ordCode)
			    // 서버로부터 주문 상세 정보를 가져오는 AJAX 요청
			    fetch('/orderDetailList/' + ordCode)
			        .then(response => response.json())
			        .then(data => {
			            // 서버로부터 받은 JSON 데이터를 사용하여 주문 상세 목록을 구성하고 출력
			            // 예시: 상세 목록을 모달 body에 출력하는 코드
			            var modalBody = $('#staticBackdropOrd .modal-body');
			            modalBody.empty();  // 기존 내용을 비우고 새로운 내용으로 채움

			            // data에는 주문 상세 정보가 포함되어 있다고 가정
			            var orderDetails = data.orderDetails;

			            // 예시: 주문 상세 목록을 테이블 형태로 구성
			            var table = $('<table>').addClass('table');
			            var thead = $('<thead>').append('<tr><th>상품명</th><th>수량</th><th>단가</th><th>총금액</th></tr>');
			            var tbody = $('<tbody>');

			            // orderDetails를 반복하면서 각 상품에 대한 정보를 테이블에 추가
			            orderDetails.forEach(function (detail) {
			                var row = $('<tr>').append(
			                    '<td>' + detail.productName + '</td>',
			                    '<td>' + detail.quantity + '</td>',
			                    '<td>' + detail.unitPrice + '</td>',
			                    '<td>' + detail.totalAmount + '</td>'
			                );
			                tbody.append(row);
			            });

			            table.append(thead, tbody);
			            modalBody.append(table);

			            // 모달을 열고 출력된 주문 상세 목록을 보여줌
			            $('#staticBackdropOrd').modal('show');
			        })
			        .catch(error => {
			            console.error('Failed to fetch order details:', error);
			        });
			}
		</script>
	</section>
</body>
</html>