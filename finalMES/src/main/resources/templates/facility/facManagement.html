<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<title>설비등록</title>
<style>
/* 기존 스타일 유지 */
#layoutSidenav_content {
	margin-top: 20px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
}

input[type="text"], input[type="date"] {
	width: 200px;
	box-sizing: border-box;
}

label {
	display: block;
	margin-bottom: 5px;
}

input[type="checkbox"] {
	margin-right: 5px;
}

button {
	margin-right: 5px;
}

#myModal3 {
	text-align: center;
}

/* 모달 스타일 */
.modal-dialog {
	max-width: 800px;
}

.modal-content {
	border-radius: 10px;
}

.modal-header {
	background-color: #007bff;
	color: white;
	border-radius: 10px 10px 0 0;
}

.modal-body {
	padding: 20px;
}

.modal-footer {
	border-radius: 0 0 10px 10px;
}

.modal-title {
	font-size: 24px;
}

.table th, .table td {
	text-align: center;
}

.modal-table {
	width: 100%;
	border-collapse: collapse;
}

.modal-table th, .modal-table td {
	padding: 10px;
	border-bottom: 1px solid #dee2e6;
}

.modal-table th {
	background-color: #f8f9fa;
}

.modal-table tbody tr:hover {
	background-color: #f2f2f2;
}

/* 모달 창 외부를 클릭하여 닫을 수 있도록 */
.modal-backdrop {
    opacity: 0.2;
}
</style>
</head>
<body>

	<section layout:fragment="content">
		<div class="container">

			<h2>설비관리</h2>
			<br>
			<div class="container">
				<table class="table">
					<tbody>
						<tr>
							<th>설비명 *</th>
							<td colspan="2"><input type="text" id="facName"
								name="facName" required></td>
							<th>최고온도 *</th>
							<td colspan="2"><input type="text" id="facHig" name="facHig"
								required></td>
						</tr>
						<tr>
							<th>최저온도 *</th>
							<td colspan="2"><input type="text" id="facLow" name="facLow"
								required></td>
							<th>입고일 *</th>
							<td colspan="2"><input type="date" id="facDate"
								name="facDate" required></td>
						</tr>
						<tr>
							<th>공정명 *</th>
							<td colspan="2"><input type="text" id="procName"
								name="procName" required data-toggle="modal"
								data-target="#myModal2"></td>

							<th>공정코드 *</th>
							<td colspan="2"><input type="text" id="procCode"
								name="procCode" required></td>

						</tr>
						<tr>
							<th>거래처 *</th>
							<td colspan="2"><input type="text" id="businessCode"
								name="businessCode" required data-toggle="modal"
								data-target="#myModal4"></td>
							<th>담당자 *</th>
							<td colspan="2"><input type="text" id="facPerson"
								name="facPerson" th:value="${username}" required></td>
						</tr>
						<tr>
							<th>점검주기 선택</th>
							<td><select id="facInscycle" name="facInscycle">
									<option value="선택">선택</option>
									<option value="매일">매일</option>
									<option value="매주">매주</option>
									<option value="매월">매월(30일)</option>
							</select></td>
						</tr>
					</tbody>
				</table>
				<br>
				<div class="text-center">
					<button type="button" id="saveBtn" class="btn btn-outline-success">저장</button>
					<button type="button" class="btn btn-outline-primary"
						onclick="downloadCSV()">엑셀 다운로드</button>
					<input type="text" id="searchInput" oninput="searchFunction()"
						placeholder="검색...">
				</div>
				<br> <br>
				<div id="grid" class="container"></div>
			</div>

		</div>
		
		<!-- 공정명모달 -->
      <div class="modal" id="myModal2">
         <div class="modal-dialog">
            <div class="modal-content">
               <!-- 모달 헤더 -->
               <div class="modal-header">
                  <h4 class="modal-title">공정명</h4>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
               </div>
               <div class="modal-body">
                  <!-- 모달 내용 데이터로 받아와야함 설비명 -->
                  <table class="table">
                     <thead>
                        <tr>
                           <th>No.</th>
                           <th>공정명</th>
                           <th>공정코드</th>
                           <th>공정등록일</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr th:each="fac: ${list}">
                           <td th:text="${facStat.count}"></td>
                           <td th:text="${fac.procName}"
                              th:data-procCode="${fac.procCode}"
                              th:data-procName="${fac.procName}"
                              onclick="updateInputFields1(this)" data-bs-dismiss="modal"></td>
                           <td th:text="${fac.procCode}"></td>
                           <!-- 날짜변환  -->
                           <td th:text="${#dates.format(fac.procDate, 'yyyy-MM-dd')}"></td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary"
                     data-dismiss="modal">닫기</button>
               </div>
            </div>
         </div>
      </div>
      
      <!-- 거래처모달 -->
      <div class="modal" id="myModal4">
         <div class="modal-dialog">
            <div class="modal-content">
               <!-- 모달 헤더 -->
               <div class="modal-header">
                  <h4 class="modal-title">거래처</h4>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
               </div>
               <div class="modal-body">
                  <!-- 모달 내용 데이터로 받아와야함 설비명 -->
                  <table class="table">
                     <thead>
                        <tr>
                           <th>거래처</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr th:each="fac: ${list}">
                           <td th:text="${fac.businessCode}"
                              th:data-businessCode="${fac.businessCode}"
                              onclick="updateInputFields3(this)" data-bs-dismiss="modal"></td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary"
                     data-dismiss="modal">닫기</button>
               </div>
            </div>
         </div>
      </div>
      
		
	

	<script th:inline="javascript">
	
	
	 function updateInputFields1(Element) {
	      // 클릭한 <td> 요소에서 데이터 속성을 가져옴
	      var procCode = Element.getAttribute('data-procCode');
	      var procName = Element.getAttribute('data-procName');

	      // 입력 필드의 값 설정
	      document.getElementById('procCode').value = procCode;
	      document.getElementById('procName').value = procName;
	      
	   }

	 function updateInputFields3(Element) {
	      var businessCode = Element.getAttribute('data-businessCode');
	      document.getElementById('businessCode').value = businessCode;
	   }

	
	// 등록
	document.getElementById('saveBtn').addEventListener("click", function() {
	      let data = {};	
		  var procCode = document.getElementsByName("procCode")[0].value;
		  var businessCode = document.getElementsByName("businessCode")[0].value;
		  var facName = document.getElementsByName("facName")[0].value;
		  var facHig = document.getElementsByName("facHig")[0].value;
		  var facLow = document.getElementsByName("facLow")[0].value;
		  var facDate = document.getElementsByName("facDate")[0].value;
		  var facInscycle = document.getElementsByName("facInscycle")[0].value;
		  var facPerson = document.getElementsByName("facPerson")[0].value;
		  
		    // 등록 시 유효성검사
		    if (!facName) {
		        alert("설비명을 입력해주세요.");
		        return;
		    }
		    
		    if (!procName) {
		        alert("공정명을 입력해주세요.");
		        return;
		    }

		    if (!procCode) {
		        alert("공정코드를 입력해주세요.");
		        return;
		    }
		    
		    if (!facPerson) {
		        alert("담당자를 입력해주세요.");
		        return;
		    }

		    if (!businessCode) {
		        alert("거래처를 입력해주세요.");
		        return;
		    }
	    
	            var facData = {
	            	procCode: procCode,
	            	businessCode: businessCode,
	                facName: facName,
	                facHig: facHig,
	                facLow: facLow,
	                facDate: facDate,
	                facInscycle: facInscycle,
	                facPerson: facPerson,
	            
	            };
	            var notData = {};
	            data.facManageVO = facData;
	            data.facNotopVO = notData;
	            
	            
	            fetch("/insrtFacAndNot", {
			        method: "POST",
			        body: JSON.stringify(data),
			        headers: {
			            "Content-Type": "application/json"
			        }
			    })
			    .then(response => {
			        if(!response.ok){
			        	throw new Error("반응 없음")
			        }
			        return response.text();
			    })
			    .then(data => {
			    	alert(data);
			    	location.href = "/facManagement"
			    })
			    .catch(error => {
			        console.log(error);
			        alert("오류");
			    });
			});
	
	
	// 엑셀 다운로드
	function downloadCSV() {
        const gridData = grid.getData(); // 그리드에서 데이터 가져오기
        const header = Object.keys(gridData[0]).join(','); // 헤더 생성
        const csv = gridData.map(row => Object.values(row).join(',')).join('\n'); // 데이터 생성

        const csvContent = `data:text/csv;charset=utf-8,${header}\n${csv}`; // CSV 내용 생성
        const encodedUri = encodeURI(csvContent); // URI 인코딩

        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'data.csv');
        document.body.appendChild(link);
        link.click();
    }
	
	
	// 그리드 페이징
	let facList = [[${list}]];
	console.log(facList);
	const grid = new tui.Grid({
		 
		el : document.getElementById('grid'),
		data : facList,
		scrollX : false,
		scrollY : false,
		columns : [ 
		{
			header : '설비코드',
			name : 'facCode',
			align: 'center'
			
		}, 
		{
			header : '설비명',
			name : 'facName',
			align: 'center'
		}, 
		{
			header : '공정라인',
			name : 'procName',
			align: 'center'
		}, 
		{
			header : '담당자',
			name : 'facPerson',
			align: 'center'
		}, 
		{
			header : '입고일',
			name : 'facDate',
		      formatter : function dateFormatter(params) {
  		    	  const date = new Date(params.value);
  		    	  const isoDate = date.toISOString().split('T')[0];
  		    	  return isoDate;
  		    	},
  		    align: 'center'
			
		},
		{
			header : '점검주기',
			name : 'facInscycle',
			align: 'center'
		} 
		],
		 rowHeaders: ['rowNum'],
         pageOptions: {
             useClient: true,
             perPage: 5
         }
	});
	
	// 검색 기능 추가
  	 function searchFunction() {
  	     var input, filter, table, tr, td, i, j, txtValue;
  	     input = document.getElementById("searchInput");
  	     filter = input.value.toUpperCase();
  	     table = document.getElementById("grid");

  	     tr = table.getElementsByTagName("tr");
  	     for (i = 0; i < tr.length; i++) {
  	         td = tr[i].getElementsByTagName("td");
  	         for (j = 0; j < td.length; j++) {
  	             txtValue = td[j].textContent || td[j].innerText;
  	             if (txtValue.toUpperCase().indexOf(filter) > -1) {
  	                 tr[i].style.display = "";
  	                 break;
  	             } else {
  	                 tr[i].style.display = "none";
  	             }
  	         }
  	     }
  	 }

</script>
</section>
</body>
</html>
