<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<title>ì„¤ë¹„ìˆ˜ë¦¬ê´€ë¦¬</title>
<style>
#layoutSidenav_content {
	margin-top: 20px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
}

input[type="text"], input[type="date"] {
	width: 200px;
	box-sizing: border-box;
}

label {
	display: block;
	margin-bottom: 5px;
}

input[type="checkbox"] {
	margin-right: 5px;
}

button {
	margin-right: 5px;
}

#myModal3 {
	text-align: center;
}
</style>
</head>
<body>

	<section layout:fragment="content">
		<h1>ì„¤ë¹„ìˆ˜ë¦¬ê´€ë¦¬</h1>

		<div id="layoutSidenav_content" class="container text-center">

			<div class="col">
				<br> <br>
				<table class="table">
					<thead>
						<tr>
							<th>ìˆ˜ë¦¬ì½”ë“œ</th>
							<th colspan="2"><input type="text" id="facRepCode"
								name="facRepCode" required readonly></th>
							<th>ì„¤ë¹„ì½”ë“œ</th>
							<th colspan="2"><input type="text" id="facCode"
								name="facCode" required readonly></th>
							

							
						</tr>
						<tr>
							<th>ìˆ˜ë¦¬ì‚¬í•­</th>
							<th colspan="2"><input type="text" id="facRepRepairs"
								name="facRepRepairs"></th>
							<th>ì„¤ë¹„ëª…</th>
							<th colspan="2"><input type="text" id="facName"
							 name="facName" th:data-facCode="${facCode}" required readonly>
						</tr>
						<tr>
							<th>ë“±ë¡ì¼ì</th>
							<th colspan="2"><input type="date" id="facRepDate"
								name="facRepDate" required></th>
							<th>ë‹´ë‹¹ì</th>
							<th colspan="2"><input type="text" id="facRepPerson"
								name="facRepPerson" required></th>
						</tr>
						<tr>
							<th>ìˆ˜ë¦¬ë‚´ìš©</th>
							<td colspan="2"><textarea rows="10" cols="30"
									id="facRepContent" name="facRepContent"></textarea>
						</tr>
					</thead>
				</table>
				<input type="hidden" id="facNotCode" name="facNotCode" value="">
				<input type="hidden" id="facNotSituation" name="facNotSituation"
					required>
				<div class="text-center">
				<button type="button" id="saveBtn" class="btn btn-outline-success">ì €ì¥</button>
				<button type="button" id="insertBtn" class="btn btn-outline-success">ë“±ë¡</button>
				<button type="button" id="selectBtn" class="btn btn-outline-success"
					data-bs-toggle="modal" data-bs-target="#staticBackdropOne">ì¡°íšŒ</button>
				<input type="text" id="searchInput" oninput="searchFunction()" placeholder="ê²€ìƒ‰...">
				</div>
				<br> <br> <br>
				<div id="grid" class="container"></div>
			</div>
		</div>

		<div class="modal fade modal-xl" id="staticBackdropOne"
			data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
			aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-scrollable">
				<!-- modal-dialog í´ë˜ìŠ¤ì— modal-dialog-scrollable í´ë˜ìŠ¤ ì¶”ê°€ -->
				<div class="modal-content">
					<div class="modal-header" style="background-color: #0d6efd;">
						<h1 class="modal-title fs-5" id="staticBackdropLabel"
							style="font-weight: bold"></h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" style="overflow-y: hidden;">
						<!-- overflow-y ì†ì„± ì¶”ê°€ -->
						<table>
							<thead style="text-align: center;">
								<tr>
									<th>ì„¤ë¹„ì½”ë“œ</th>
									<th>ì„¤ë¹„ëª…</th>
									<th>ë‹´ë‹¹ì</th>
									<th>ë¹„ê°€ë™ë“±ë¡ì‚¬ìœ </th>
									<th>ìƒíƒœ</th>
								</tr>
							</thead>
							
							<tbody style="text-align: center;">
								<tr th:each="NotIns : ${Replist}"
									th:data-facNotCode="${NotIns.facNotCode}"
									th:data-facCode="${NotIns.facCode}"
									th:data-facName="${NotIns.facName}"
									th:data-facNotPerson="${NotIns.facNotPerson}"
									th:data-facNotReason="${NotIns.facNotReason}"
									th:data-facNotSituation="${NotIns.facNotSituation}"
									data-bs-dismiss="modal"
									th:onclick="'displaySelectedFacNotIns(this)'">
									<td th:text="${NotIns.facCode}"></td>
									<td th:text="${NotIns.facName}"></td>
									<td th:text="${NotIns.facNotPerson}"></td>
									<td th:text="${NotIns.facNotReason}"></td>
									<td th:text="${NotIns.facNotSituation}"></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="modal-footer" style="background-color: #0d6efd;">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>


		<script th:inline="javascript">
           
		document.getElementById('saveBtn').addEventListener("click", function() {
		    var facRepRepairs = document.getElementsByName("facRepRepairs")[0].value;
		    
		    // ìˆ˜ë¦¬ì‚¬í•­ì˜ ê¸¸ì´ê°€ 15ë¥¼ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸
		    if (facRepRepairs.length > 15) {
		        alert("ìˆ˜ë¦¬ì‚¬í•­ì€ 15ê¸€ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }

		    // ìˆ˜ë¦¬ì‚¬í•­ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
		    if (!facRepRepairs.trim()) {
		        alert("ìˆ˜ë¦¬ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }

		    // ë‚˜ë¨¸ì§€ í•„ë“œë“¤ì˜ ê°’ì„ ê°€ì ¸ì˜´
		    var facRepCode = document.getElementsByName("facRepCode")[0].value;
		    var facNotCode = document.getElementsByName("facNotCode")[0].value;
		    var facCode = document.getElementsByName("facCode")[0].value;
		    var facName = document.getElementsByName("facName")[0].value;
		    var facRepPerson = document.getElementsByName("facRepPerson")[0].value;
		    var facRepContent = document.getElementsByName("facRepContent")[0].value;
		    var facRepDate = document.getElementsByName("facRepDate")[0].value;
		    var facNotSituation = document.getElementsByName("facNotSituation")[0].value;

		    var data = {
		        facRepCode: facRepCode,
		        facNotCode: facNotCode,
		        facCode: facCode,
		        facName: facName,
		        facRepRepairs: facRepRepairs,
		        facRepPerson: facRepPerson,
		        facRepContent: facRepContent,
		        facRepDate: facRepDate,
		        facNotSituation: facNotSituation
		    };

		    // JSON.stringify() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³€í™˜
		    var jsonData = JSON.stringify(data);
		    
		    // fac_ins update
		    fetch("/updateFacRep", {
		        method: "PUT",
		        body: jsonData, // JSON í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì „ì†¡
		        headers: {
		            "Content-Type": "application/json" // JSON í˜•ì‹ì˜ ë°ì´í„°ì„ì„ ëª…ì‹œ
		        }
		    })
		    .then(response => {
		        console.log(response.status);
		        if (response.ok) {
		            console.log(response);
		            alert("ë“±ë¡ì™„ë£Œ!");
		            location.href = '/facRep';  // ì—¬ê¸° ê²½ë¡œë¡œ ê°€ë¼
		        } else {
		            console.log(response);
		            alert("ë“±ë¡ì‹¤íŒ¨");
		        }
		    })
		    .catch(error => {
		        console.log(error);
		        alert(ì˜¤ë¥˜);
		    });
		});

        
         
        
          document.getElementById('insertBtn').addEventListener("click", function() {
        	    var facRepRepairs = document.getElementsByName("facRepRepairs")[0].value;
        	    
        	    // ìˆ˜ë¦¬ì‚¬í•­ì˜ ê¸¸ì´ê°€ 15ë¥¼ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸
        	    if (facRepRepairs.length > 15) {
        	        alert("ìˆ˜ë¦¬ì‚¬í•­ì€ 15ê¸€ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        	        return;
        	    }

        	    // ìˆ˜ë¦¬ì‚¬í•­ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        	    if (!facRepRepairs.trim()) {
        	        alert("ìˆ˜ë¦¬ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        	        return;
        	    }

        	    // ë‚˜ë¨¸ì§€ í•„ë“œë“¤ì˜ ê°’ì„ ê°€ì ¸ì˜´
        	    var facRepCode = document.getElementsByName("facRepCode")[0].value;
        	    var facNotCode = document.getElementsByName("facNotCode")[0].value;
        	    var facCode = document.getElementsByName("facCode")[0].value;
        	    var facName = document.getElementsByName("facName")[0].value;
        	    var facRepPerson = document.getElementsByName("facRepPerson")[0].value;
        	    var facRepContent = document.getElementsByName("facRepContent")[0].value;
        	    var facRepDate = document.getElementsByName("facRepDate")[0].value;

        	    var data = {
        	        facRepCode: facRepCode,
        	        facNotCode: facNotCode,
        	        facCode: facCode,
        	        facName: facName,
        	        facRepRepairs: facRepRepairs,
        	        facRepPerson: facRepPerson,
        	        facRepContent: facRepContent,
        	        facRepDate: facRepDate,
        	    };

        	    // JSON.stringify() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³€í™˜
        	    var jsonData = JSON.stringify(data);
        	    
        	    // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡í•˜ì—¬ insert ìˆ˜í–‰
        	    fetch("/insertFacRep", {
        	        method: "POST",
        	        body: jsonData, // JSON í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì „ì†¡
        	        headers: {
        	            "Content-Type": "application/json" // JSON í˜•ì‹ì˜ ë°ì´í„°ì„ì„ ëª…ì‹œ
        	        }
        	    })
        	    .then(response => {
        	        if (response.ok) {
        	            console.log(response);
        	            alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        	            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        	            location.reload();
        	        } else {
        	            console.log(response);
        	            alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        	        }
        	    })
        	    .catch(error => {
        	        console.error('Error:', error);
        	        alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        	    });
        	});

         	

         	
        // ê·¸ë¦¬ë“œ í˜ì´ì§•
    
        const grid = new tui.Grid({
            el: document.getElementById('grid'),
            data: [],
            scrollX: false,
            scrollY: false,
            columns: [
                {
                    header: 'ìˆ˜ë¦¬ì½”ë“œ',
                    name: 'facRepCode',
                    align: 'center',
                },
                {
                    header: 'ì„¤ë¹„ëª…',
                    name: 'facName',
                    align: 'center',
                },
                {
                    header: 'ì„¤ë¹„ì½”ë“œ',
                    name: 'facCode',
                    align: 'center',
                },
                {
                    header: 'ìˆ˜ë¦¬ì‚¬í•­',
                    name: 'facRepRepairs',
                    align: 'center'
                },
                {
                    header: 'ë‹´ë‹¹ì',
                    name: 'facRepPerson',
                    align: 'center'
                },
                {
                    header: 'ìˆ˜ë¦¬ë‚´ìš©',
                    name: 'facRepContent',
                    align: 'center'
                },
                {
                    header: 'ë“±ë¡ì¼ì',
                    name: 'facRepDate',
                    formatter :  formatDate,
                    align: 'center'
                },
                {
         	          header: 'ìƒíƒœ',
         	          name: 'facNotSituation',
         	          formatter: function(value) {
         	            var numericValue = +value.value;

         	            if (numericValue === 0) {
         	              return 'ğŸŸ¡';
         	            } else if (numericValue === 1) {
         	              return 'ğŸŸ¢';
         	            } else if (numericValue === 2) {
         	              return 'ğŸ”´';
         	            } else {
         	              return 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ';
         	            }
         	          },
         	          align: 'center'
         	        }
       
            ],
            rowHeaders: ['rowNum'],
            pageOptions: {
                useClient: true,
                perPage: 5
            }
        });
        
    
         	
     	fetch("/FacRepList")
        .then(response => response.json())
        .then(data => {
            grid.resetData(data); // ê·¸ë¦¬ë“œì— ë°ì´í„°ë¥¼ ì„¤ì •
            console.log("ì—¬ê¸°ê¹Œì§„ ì˜¨ë‹¹!");
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!");
        });
        
     	
     	
        //  ì°¨ê¸°ì ê²€ì„ ë‚ ì§œí¬ë§·
        function formatDate(dateString) {
        	console.log(dateString);
            // dateStringì„ Date ê°ì²´ë¡œ íŒŒì‹±
            const date = new Date(dateString.value);
            // ë‚ ì§œ í¬ë§· ë³€ê²½
            const formattedDate = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
            return formattedDate;
        }
        
     // ì„¤ë¹„ëª… í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬í•´ì„œ ìœ„ì— input ë°•ìŠ¤ì— ê°’ë„£ê¸°
        function handleFacNameClick(event) {
            // í´ë¦­í•œ í–‰ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const rowData = grid.getRowAt(event.rowKey);
			
            // ì„¤ë¹„ëª…ê³¼ ë‹´ë‹¹ì ê°’ì„ ê°€ì ¸ì™€ì„œ input ë°•ìŠ¤ì— ë„£ê¸°
            const facRepCode = rowData.facRepCode;
            const facCode = rowData.facCode;
            const facNotCode = rowData.facNotCode;
            const facName = rowData.facName;
            const facRepPerson = rowData.facRepPerson;
            const facRepRepairs = rowData.facRepRepairs;
            const facRepContent = rowData.facRepContent;
            const facRepDate = rowData.facRepDate;
            const facNotSituation = rowData.facNotSituation;
            
            document.getElementById('facRepCode').value = facRepCode;
            document.getElementById('facCode').value = facCode;
            document.getElementById('facNotCode').value = facNotCode;
            document.getElementById('facName').value = facName;
            document.getElementById('facRepPerson').value = facRepPerson;
            document.getElementById('facRepRepairs').value = facRepRepairs;
            document.getElementById('facRepContent').value = facRepContent;
            document.getElementById('facRepDate').value = facRepDate;
            document.getElementById('facNotSituation').value = facNotSituation;
        }

        // grid ìƒì„± ì½”ë“œ ì•„ë˜ì— ì„¤ë¹„ëª… í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        grid.on('click', (event) => {
            if (event.columnName === 'facName') {
                handleFacNameClick(event);
            }
        });
		
        
        
        function displaySelectedFacNotIns(element) {
    		var facCode = element.getAttribute('data-facCode');
    		var facNotCode = element.getAttribute('data-facNotCode');
    		var facName = element.getAttribute('data-facName');
    		var facNotPerson = element.getAttribute('data-facNotPerson');
    		var facNotReason = element.getAttribute('data-facNotReason');
    		var facNotSituation = element.getAttribute('data-facNotSituation');
    		
    		document.getElementById('facCode').value = facCode;
    		document.getElementById('facNotCode').value = facNotCode;
    		document.getElementById('facName').value = facName;
    		document.getElementById('facNotPerson').value = facNotPerson;
    		document.getElementById('facNotReason').value = facNotReason;
    		document.getElementById('facNotSituation').value = facNotSituation;
    	}
        
     // ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
     	 function searchFunction() {
     	     var input, filter, table, tr, td, i, j, txtValue;
     	     input = document.getElementById("searchInput");
     	     filter = input.value.toUpperCase();
     	     table = document.getElementById("grid");

     	     tr = table.getElementsByTagName("tr");
     	     for (i = 0; i < tr.length; i++) {
     	         td = tr[i].getElementsByTagName("td");
     	         for (j = 0; j < td.length; j++) {
     	             txtValue = td[j].textContent || td[j].innerText;
     	             if (txtValue.toUpperCase().indexOf(filter) > -1) {
     	                 tr[i].style.display = "";
     	                 break;
     	             } else {
     	                 tr[i].style.display = "none";
     	             }
     	         }
     	     }
     	 }
    	
    </script>
	</section>
</body>
</html>
