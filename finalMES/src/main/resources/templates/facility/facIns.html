<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<title>ì„¤ë¹„ë¹„ì ê²€ê´€ë¦¬</title>
<style>
#layoutSidenav_content {
	margin-top: 20px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-bottom: 20px;
}

input[type="text"], input[type="date"] {
	width: 200px;
	box-sizing: border-box;
}

label {
	display: block;
	margin-bottom: 5px;
}

input[type="checkbox"] {
	margin-right: 5px;
}

button {
	margin-right: 5px;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal-dialog {
	max-width: 800px;
}

.modal-content {
	border-radius: 10px;
}

.modal-header {
	background-color: #007bff;
	color: white;
	border-radius: 10px 10px 0 0;
}

.modal-body {
	padding: 20px;
}

.modal-footer {
	border-radius: 0 0 10px 10px;
}

.modal-title {
	font-size: 24px;
}

.table th, .table td {
	text-align: center;
}

.modal-table {
	width: 100%;
	border-collapse: collapse;
}

.modal-table th, .modal-table td {
	padding: 10px;
	border-bottom: 1px solid #dee2e6;
}

.modal-table th {
	background-color: #f8f9fa;
}

.modal-table tbody tr:hover {
	background-color: #f2f2f2;
}
</style>
</head>
<body>

	<section layout:fragment="content">
		<h1>ì„¤ë¹„ì ê²€ê´€ë¦¬</h1>

		<div class="container">

			<div class="col">
				<br> <br>
				<table class="table">
					<thead>
						<tr>
							<th>ì ê²€ì½”ë“œ</th>
							<th colspan="2"><input type="text" id="facInsCode"
								name="facInsCode" required readonly></th>
							<th>ì„¤ë¹„ì½”ë“œ</th>
							<th colspan="2"><input type="text" id="facCode"
								name="facCode" required></th>
							<th>ì„¤ë¹„ëª…</th>
							<th colspan="2"><input type="text" id="facName"
								name="facName" th:data-facCode="${facCode}" required></th>

						</tr>
						<tr>
							<th>ì ê²€ì‚¬í•­</th>
							<th colspan="2"><input type="text" id="facInsCheck"
								name="facInsCheck"></th>
							<!-- <th>íŒì •</th>
                     <th colspan="2"><input type="text" id="facInsJud"
                        name="facInsJud"></th> -->
							<th>ë‹´ë‹¹ì</th>
							<th colspan="2"><input type="text" id="facInsPerson"
								name="facInsPerson" th:value="${username}" required></th>
						</tr>
						<tr>
						<tr>
							<th style="vertical-align: middle;">íŒì •</th>
							<td colspan="2" style="vertical-align: middle;"><label
								style="margin-right: 10px;"> <input type="radio"
									id="facInsJud1" name="facInsJud" value="ì í•©"> ì í•©
							</label> <label> <input type="radio" id="facInsJud2"
									name="facInsJud" value="ë¶€ì í•©"> ë¶€ì í•©
							</label></td>
						</tr>
					</thead>
				</table>
				<input type="hidden" id="facNotCode" name="facNotCode" required>
				<input type="hidden" id="facNotSituation" name="facNotSituation"
					required>
				<div class="text-center">
					<button type="button" id="saveBtn" class="btn btn-outline-success">ì €ì¥</button>
					<button type="button" id="insertBtn"
						class="btn btn-outline-success">ë“±ë¡</button>
					<button type="button" id="selectBtn"
						class="btn btn-outline-success" data-bs-toggle="modal"
						data-bs-target="#staticBackdropOne">ì¡°íšŒ</button>
					<button type="button" class="btn btn-outline-primary"
						onclick="downloadCSV()">Excel</button>
					<input type="text" id="searchInput" oninput="searchFunction()"
						placeholder="ê²€ìƒ‰...">
				</div>
				<br> <br> <br>
				<div id="grid" class="container"></div>
			</div>
		</div>





		<div class="modal fade modal-xl" id="staticBackdropOne"
			data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
			aria-labelledby="staticBackdropLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-scrollable">
				<!-- modal-dialog í´ë˜ìŠ¤ì— modal-dialog-scrollable í´ë˜ìŠ¤ ì¶”ê°€ -->
				<div class="modal-content">
					<div class="modal-header" style="background-color: #0d6efd;">
						<h1 class="modal-title fs-5" id="staticBackdropLabel"
							style="font-weight: bold">ì„¤ë¹„ëª©ë¡</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>

					<div class="modal-body" style="overflow-y: hidden;">
						<!-- overflow-y ì†ì„± ì¶”ê°€ -->
						<table>
							<thead style="text-align: center;">
								<tr>
									<th>ì„¤ë¹„ì½”ë“œ</th>
									<th>ì„¤ë¹„ëª…</th>
									<!-- <th>ë‹´ë‹¹ì</th> -->
									<th>ë¹„ê°€ë™ë“±ë¡ì‚¬ìœ </th>
									<th>ìƒíƒœ</th>
								</tr>
							</thead>
							<tbody style="text-align: center;">
								<!-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë´ì•¼í•¨ -->
								<tr th:each="NotIns : ${Inslist}"
									th:data-facNotCode="${NotIns.facNotCode}"
									th:data-facCode="${NotIns.facCode}"
									th:data-facName="${NotIns.facName}"
									th:data-facNotPerson="${NotIns.facNotPerson}"
									th:data-facNotReason="${NotIns.facNotReason}"
									th:data-facNotSituation="${NotIns.facNotSituation}"
									data-bs-dismiss="modal"
									th:onclick="'displaySelectedFacNotIns(this)'">
									<td th:text="${NotIns.facCode}"></td>
									<td th:text="${NotIns.facName}"></td>
									<td th:text="${NotIns.facNotPerson}"></td>
									<td th:text="${NotIns.facNotReason}"></td>
									<td th:text="${NotIns.facNotSituation}"></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="modal-footer" style="background-color: #0d6efd;">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>


		<script th:inline="javascript">
         
        // saveBtn ë²„íŠ¼ì— ì´ë²¤íŠ¸ ê±¸ì–´ì„œ í´ë¦­ ì‹œ í•´ë‹¹ í•¨ìˆ˜ ì‹¤í–‰ 
		document.getElementById('saveBtn').addEventListener("click", function() {
    // ê°ê°ì˜ ë³€ìˆ˜ì— íŠ¹ì • ì´ë¦„ì„ ê°€ì§„ ìš”ì†Œì˜ ê°’ì„ í• ë‹¹ ì¸ë±ìŠ¤ 0ì— ìˆëŠ” ìš”ì†Œì˜ ê°’ì„ ê°€ì ¸ì˜´
		    var facInsCode = document.getElementsByName("facInsCode")[0].value;
		    var facNotCode = document.getElementsByName("facNotCode")[0].value;
		    var facCode = document.getElementsByName("facCode")[0].value;
		    var facName = document.getElementsByName("facName")[0].value;
		    var facInsPerson = document.getElementsByName("facInsPerson")[0].value;
		    var facInsCheck = document.getElementsByName("facInsCheck")[0].value;
		    var facNotSituation = document.getElementsByName("facNotSituation")[0].value;
		    var facInsJud;

		    // íŒì • ê°’ì„ ê°€ì ¸ì˜¤ê¸°
		    var facInsJudElements = document.getElementsByName("facInsJud");
		    for (var i = 0; i < facInsJudElements.length; i++) {
		        if (facInsJudElements[i].checked) {
		            facInsJud = facInsJudElements[i].value;
		            break;
		        }
		    }
		
		    // ì¡°ê±´
		    if (!facName) {
		        alert("ì„¤ë¹„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }

    		// ë°ì´í„° ê°ì²´ì— ìœ„ì—ì„œ ê°€ì ¸ì˜¨ ê°’ë“¤ ë„£ê¸°
		    var data = {
		        facInsCode: facInsCode,
		        facNotCode: facNotCode,
		        facCode: facCode,
		        facName: facName,
		        facInsPerson: facInsPerson,
		        facInsCheck: facInsCheck,
		        facInsJud: facInsJud,
		        facNotSituation: facNotSituation
		        
		    };

			    // fac_ins update
			    // fatchë¥¼ í†µí•´ ì„œë²„ì— PUT í†µì‹  ìš”ì²­
			    fetch("/updateFacIns", {
			        method: "PUT",
			        body: JSON.stringify(data),   // ë°ì´í„° JSON í˜•ì‹ìœ¼ë¡œ ë¬¸ìì—´ ë³€í™˜
			        headers: {
			            "Content-Type": "application/json"  // íƒ€ì…ì´ JSON í˜•ì‹ì´ë‹¤
			        }
			    })
			    .then(response => {
			        console.log(response.status);
			        if (response.ok) {
			            console.log(response);
			            alert("ìˆ˜ì •ì™„ë£Œ!");
			            location.href = '/facIns';  // ì—¬ê¸° ê²½ë¡œë¡œ ë¦¬ë””ë ‰ì…˜
			        } else {
			            console.log(response);
			            alert("ìˆ˜ì •ì‹¤íŒ¨");
			        }
			    })
			    .catch(error => {
			        console.log(error);
			        alert("ì˜¤ë¥˜");
			    });
			});

        
         
         // facIns Insert
         // insertBtn ì— ì´ë²¤íŠ¸ ê±¸ì–´ì„œ í•´ë‹¹ ë²„íŠ¼ í´ë¦­ ì‹œ í•¨ìˆ˜ ì‹¤í–‰
         document.getElementById('insertBtn').addEventListener("click", function() {
              // ê°ê°ì˜ ë³€ìˆ˜ì— íŠ¹ì • ì´ë¦„ì„ ê°€ì§„ ìš”ì†Œì˜ ê°’ì„ í• ë‹¹ ì¸ë±ìŠ¤ 0ì— ìˆëŠ” ìš”ì†Œì˜ ê°’ì„ ê°€ì ¸ì˜´
                var facInsCode = document.getElementsByName("facInsCode")[0].value;
                var facNotCode = document.getElementsByName("facNotCode")[0].value;
                var facCode = document.getElementsByName("facCode")[0].value;
                var facName = document.getElementsByName("facName")[0].value;
                var facInsPerson = document.getElementsByName("facInsPerson")[0].value;
                var facInsCheck = document.getElementsByName("facInsCheck")[0].value;
                var facInsJud = document.getElementsByName("facInsJud")[0].value;

                
            // ì¡°ê±´
                if (!facName || !facInsPerson) {
                    alert("ì„¤ë¹„ëª…ê³¼ ë‹´ë‹¹ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

            // data ê°ì²´ì— ìœ„ì—ì„œ ë°›ì•„ì˜¨ ê°’ ë„£ê¸°
                var data = {
                    facInsCode: facInsCode,
                    facNotCode: facNotCode,
                    facCode: facCode,
                    facName: facName,
                    facInsPerson: facInsPerson,
                    facInsCheck: facInsCheck,
                    facInsJud: facInsJud,

                };
                
                // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡í•˜ì—¬ insert ìˆ˜í–‰
                fetch("/insertFacIns", {
                    method: "POST",
                    body: JSON.stringify(data),  // JSON í˜•ì‹ìœ¼ë¡œ ë¬¸ìì—´ ë³€í™˜
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log(response);
                        alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                        location.reload();
                    } else {
                        console.log(response);
                        alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            });

            

            
        // ê·¸ë¦¬ë“œ í˜ì´ì§•
    
        const grid = new tui.Grid({
            el: document.getElementById('grid'),
            data: [],
            scrollX: false,
            scrollY: false,
            columns: [
                {
                    header: 'ì ê²€ì½”ë“œ',
                    name: 'facInsCode',
                    align: 'center',
                },
                {
                    header: 'ì„¤ë¹„ëª…',
                    name: 'facName',
                    align: 'center',
                },
                {
                    header: 'ì„¤ë¹„ì½”ë“œ',
                    name: 'facCode',
                    align: 'center',
                },
                {
                    header: 'ì ê²€ì‚¬í•­',
                    name: 'facInsCheck',
                    align: 'center'
                },
                {
                    header: 'ë‹´ë‹¹ì',
                    name: 'facInsPerson',
                    align: 'center'
                },
                {
                    header: 'íŒì •',
                    name: 'facInsJud',
                    align: 'center'
                },
                {
                    header: 'ì ê²€ì¼',
                    name: 'facInsDate',
                    formatter :  formatDate,
                    align: 'center'
                },
                {
                    header: 'ì°¨ê¸°ì ê²€ì¼',
                    name: 'facInsNexd',
                    formatter : formatDate,
                    align: 'center'
                },
                {
         	          header: 'ìƒíƒœ',
         	          name: 'facNotSituation',
         	          formatter: function(value) {
         	            var numericValue = +value.value;

         	            if (numericValue === 0) {
         	              return 'ğŸŸ¡';
         	            } else if (numericValue === 1) {
         	              return 'ğŸŸ¢';
         	            } else if (numericValue === 2) {
         	              return 'ğŸ”´';
         	            } else {
         	              return 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ';
         	            }
         	          },
         	          align: 'center'
         	        }
              
            ],
            rowHeaders: ['rowNum'],
            // í˜ì´ì§€ë„¤ì´ì…˜
            pageOptions: {
                useClient: true,
                perPage: 5
            }
        });
        
        // get ë°©ì‹
        fetch("/facInsList")
        .then(response => response.json())
        .then(data => {
            grid.resetData(data); // ê·¸ë¦¬ë“œì— ë°ì´í„°ë¥¼ ì„¤ì •
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!");
        }); 
        
        
        //  ì°¨ê¸°ì ê²€ì„ ë‚ ì§œí¬ë§·
        function formatDate(dateString) {
           console.log(dateString);
            // dateStringì„ Date ê°ì²´ë¡œ íŒŒì‹±
            const date = new Date(dateString.value);
            // ë‚ ì§œ í¬ë§· ë³€ê²½
            const formattedDate = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
            return formattedDate;
        }
        
        // ì„¤ë¹„ëª… í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬í•´ì„œ ìœ„ì— input ë°•ìŠ¤ì— ê°’ë„£ê¸°
        function handleFacNameClick(event) {
            // í´ë¦­í•œ í–‰ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const rowData = grid.getRowAt(event.rowKey);
         
            // ì„¤ë¹„ëª…ê³¼ ë‹´ë‹¹ì ê°’ì„ ê°€ì ¸ì™€ì„œ input ë°•ìŠ¤ì— ë„£ê¸°
            const facName = rowData.facName;
            /* const facInsPerson = rowData.facInsPerson; */
            const facInsCode = rowData.facInsCode;
            const facCode = rowData.facCode;
            const facNotCode = rowData.facNotCode;
            const facInsCheck = rowData.facInsCheck;

            
            document.getElementById('facInsCode').value = facInsCode;
            document.getElementById('facNotCode').value = facNotCode;
            document.getElementById('facCode').value = facCode;
            document.getElementById('facName').value = facName;
            document.getElementById('facInsCheck').value = facInsCheck;
            /* document.getElementById('facInsPerson').value = facInsPerson; */
        }

        // grid ìƒì„± ì½”ë“œ ì•„ë˜ì— ì„¤ë¹„ëª… í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        grid.on('click', (event) => {
            if (event.columnName === 'facName') {
                handleFacNameClick(event);
            }
        });
      
        
        
       function displaySelectedFacNotIns(element) {
          var facCode = element.getAttribute('data-facCode');
          var facNotCode = element.getAttribute('data-facNotCode');
          var facName = element.getAttribute('data-facName');
          /* var facInsPerson = element.getAttribute('data-facInsPerson'); */
          
          var facNotSituation = element.getAttribute('data-facNotSituation');
          
          
          document.getElementById('facCode').value = facCode;
          document.getElementById('facNotCode').value = facNotCode;
          document.getElementById('facName').value = facName;
          /* document.getElementById('facInsPerson').value = facNotPerson; */
         
          document.getElementById('facNotSituation').value = facNotSituation;
       }
       
       // ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
       function searchFunction() {
           // ì…ë ¥ëœ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
           var input, filter, table, tr, td, i, j, txtValue;
           input = document.getElementById("searchInput");
           // ëŒ€ë¬¸ìë¡œë³€í™˜í•˜ê¸°
           filter = input.value.toUpperCase();
           // í…Œì´ë¸” í™•ì¸
           table = document.getElementById("grid");

           // í…Œì´ë¸” ëŒë©´ì„œ í™•ì¸
           tr = table.getElementsByTagName("tr");
           for (i = 0; i < tr.length; i++) {
               // ê° í–‰ì—ì„œ ì…€ì„ ê°€ì ¸ì˜¤ê¸°
               td = tr[i].getElementsByTagName("td");
               // í–‰ì˜ ê° ì…€ ëŒë©´ì„œ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
               for (j = 0; j < td.length; j++) {
                   // ì…€ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê¸°
                   txtValue = td[j].textContent || td[j].innerText;
                   // ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê¸°
                   if (txtValue.toUpperCase().indexOf(filter) > -1) {
                       tr[i].style.display = "";
                       break;
                   } else {
                       // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ì•ˆë³´ì´ê²Œ display none ì²˜ë¦¬
                       tr[i].style.display = "none";
                   }
               }
           }
       }
       
       
       // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
       function downloadCSV() {
           const gridData = grid.getData(); // ê·¸ë¦¬ë“œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
           const header = ['ì ê²€ì½”ë“œ', 'ì„¤ë¹„ëª…', 'ì„¤ë¹„ì½”ë“œ', 'ì ê²€ì‚¬í•­', 'ë‹´ë‹¹ì', 'íŒì •', 'ì ê²€ì¼', 'ì°¨ê¸°ì ê²€ì¼', 'ìƒíƒœ']; // í—¤ë” ìƒì„±
           const csvRows = [header.join(',')]; // í—¤ë”ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì²« ë²ˆì§¸ í–‰ìœ¼ë¡œ ì„¤ì •

           // ë°ì´í„° ìƒì„±
           gridData.forEach(row => {
               const values = Object.values(row);
               const formattedRow = values.map(value => {
                   if (value instanceof Date) {
                       // ë‚ ì§œì˜ ê²½ìš° ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                       return value.toISOString().split('T')[0];
                   } else {
                       return value;
                   }
               });
               csvRows.push(formattedRow.join(','));
           });

           // CSV ë‚´ìš© ìƒì„±
           const csvContent = 'data:text/csv;charset=utf-8,' + csvRows.join('\n');
           const encodedUri = encodeURI(csvContent); // URI ì¸ì½”ë”©

           // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
           const link = document.createElement('a');
           link.setAttribute('href', encodedUri);
           link.setAttribute('download', 'data.csv');
           document.body.appendChild(link);
           link.click();
       }
        
    </script>
	</section>
</body>
</html>