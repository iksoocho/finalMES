<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>생산계획관리</title>
</head>
<body>
	<section layout:fragment="content">
		<div class="container">
			<!-- ============================모달창============================ -->
			<div class="modal fade modal-xl" id="exampleModal" tabindex="-1"
				aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">title</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<!-- ============================모달 내용============================ -->
						<div class="modal-body">
							<div>
								<h4>주문서</h4>
								<!-- <button class="btn btn-secondary" style="float: right; margin: 0 5px;">선택</button> -->
								<table class="table">
									<thead>
										<tr>
											<th></th>
											<th>주문코드</th>
											<th>주문일자</th>

											<th>비고</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="ord : ${ordList}"
											th:data-ord-code="${ord.ordCode}" class="ord-row">
											<td><input type="checkbox"></td>
											<td th:text="${ord.ordCode}"></td>
											<td th:text="${#dates.format(ord.ordDate, 'yyyy-MM-dd')}"></td>
											<td th:text="${ord.ordNote}"></td>
										</tr>
									</tbody>
								</table>
							</div>

							<div id="orderDetails"></div>

						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary">Save
								changes</button>
						</div>
					</div>
				</div>
			</div>

			<!-- ============================메인============================ -->
			<h2>생산계획관리</h2>
			<div>
				<div>
					<button class="btn btn-secondary"
						style="float: right; margin: 0 5px;">저장</button>
					<button class="btn btn-secondary" data-bs-toggle="modal"
						data-bs-target="#exampleModal" style="float: right;">주문서
						조회</button>
					<table class="table">
						<thead>
							<tr>
								<th>No</th>
								<th>생산계획코드</th>
								<th>주문코드</th>
								<th>계획명</th>
								<th>담당자</th>
								<th>생산계획일자</th>

							</tr>
						</thead>
						<tbody>
							
								<tr th:each="plan : ${list}" th:data-plan-code="${plan.planCode}" class="plan-row">
									<td th:text="${planStat.count}"></td>
									<td th:text="${plan.planCode}"></td>
									<td th:text="${plan.ordCode}"></td>
									<td th:text="${plan.planTitle}"></td>
									<td th:text="${plan.planPerson}"></td>
									<td th:text="${#dates.format(plan.planDate, 'yyyy-MM-dd')}"></td>


								</tr>
							
						</tbody>
					</table>
				</div>
				<!-- ============================생산상세계획============================ -->
				<div id="planDetails"></div>

			</div>
		</div>
			<script>
			 // 초기에 모달 창을 만들 때 테이블 헤더를 미리 추가합니다.
		    const detailsContainer = document.getElementById('orderDetails');
		    const table = document.createElement('table');
		    table.className = 'table';
	
		    const thead = document.createElement('thead');
		    thead.innerHTML = `
		        <tr>
		            <th>제품 코드</th>
		            <th>주문 수량</th>
		            <th>납기일자</th>
		        </tr>
		    `;
		    table.appendChild(thead);
	
		    detailsContainer.appendChild(table);
	
		    document.querySelectorAll('.ord-row').forEach(row => {
		        row.addEventListener('click', function() {
		            const ordCode = this.getAttribute('data-ord-code');
		            fetch('/orderDetail?ordCode=' + ordCode)
		                .then(response => response.json())
		                .then(data => {
		                    // 테이블 본문을 업데이트합니다.
		                    const tbody = document.createElement('tbody');
	
		                    data.forEach(detail => {
		                        const tr = document.createElement('tr');
		                        tr.innerHTML = `
		                            <td>${detail.prodCode}</td>
		                            <td>${detail.ordCount}</td>
		                            <td>${detail.dlvyDate}</td>
		                        `;
		                        tbody.appendChild(tr);
		                    });
	
		                    // 기존 테이블 본문을 제거하고 새로운 테이블 본문으로 교체합니다.
		                    const existingTbody = table.querySelector('tbody');
		                    if (existingTbody) {
		                        table.removeChild(existingTbody);
		                    }
		                    table.appendChild(tbody);
		                });
		        });
		    });
		    
		    const planDetails = document.getElementById('planDetails');
		    const table2 = document.createElement('table');
		    table2.className = 'table';
		    
		    const thead2 = document.createElement('thead');
		    thead2.innerHTML = `
		    	<tr>
					<th>No</th>
					<th>생산계획코드</th>
					<th>제품코드</th>
					<th>생산계획 시작일자</th>
					<th>생산계획 종료일자</th>
					<th>현재재고</th>
					<th>주문수량</th>
					<th>계획량</th>
					<th>납기/마감일자</th>
				</tr>
		    `;
		    table2.appendChild(thead2);
		    
		    planDetails.appendChild(table2);
		    
		    document.querySelectorAll('.plan-row').forEach(row => {
		        row.addEventListener('click', function() {
		            const planCode = this.getAttribute('data-plan-code');
		            fetch('/planDetail?planCode=' + planCode)
		                .then(response => response.json())
		                .then(data => {
		                    // 테이블 본문을 업데이트합니다.
		                    const tbody2 = document.createElement('tbody');
	
		                    data.forEach(detail => {
		                    	console.log(detail);
		                        const tr2 = document.createElement('tr');
		                        tr2.innerHTML = `
		                            <td>${detail.dplanCode}</td>
		                            <td>${detail.planCode}</td>
		                            <td>${detail.prodCode}</td>
		                        `;
		                        tbody2.appendChild(tr2);
		                    });
	
		                    // 기존 테이블 본문을 제거하고 새로운 테이블 본문으로 교체합니다.
		                    const existingTbody2 = table2.querySelector('tbody');
		                    if (existingTbody2) {
		                        table2.removeChild(existingTbody2);
		                    }
		                    table2.appendChild(tbody2);
		                });
		        });
		    });
		</script>
	</section>

</body>
</html>