<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>생산계획관리</title>
</head>
<body>
	<section layout:fragment="content">
		<div class="container">
			<!-- ============================모달창============================ -->
			<div class="modal fade modal-xl" id="exampleModal" tabindex="-1"
				aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">title</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<!-- ============================모달 내용============================ -->
						<div class="modal-body">
							<div>
								<h4>주문서</h4>
								<!-- <button class="btn btn-secondary" style="float: right; margin: 0 5px;">선택</button> -->
								<table class="table">
									<thead>
										<tr>
											<th></th>
											<th>주문코드</th>
											<th>주문일자</th>

											<th>비고</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="ord : ${ordList}"
											th:data-ord-code="${ord.ordCode}" class="ord-row">
											<td>
												<div class="form-check">
													<input class="form-check-input" type="radio"
														name="flexRadioDefault" th:id="${ord.ordCode}"> <label
														class="form-check-label" th:for="${ord.ordCode}"></label>
												</div>
											</td>
											<td th:text="${ord.ordCode}"></td>
											<td th:text="${#dates.format(ord.ordDate, 'yyyy-MM-dd')}"></td>
											<td th:text="${ord.ordNote}"></td>
										</tr>
									</tbody>
								</table>
							</div>

							<div id="orderDetails"></div>

						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn btn-primary" id="addPlanBtn">추가</button>
						</div>
					</div>
				</div>
			</div>

			<!-- ============================메인============================ -->
			<h2>생산계획관리</h2>
			<div>
				<div>
					<button class="btn btn-secondary"
						style="float: right; margin: 0 5px;" id="planInsert">저장</button>
					<button class="btn btn-secondary" data-bs-toggle="modal"
						data-bs-target="#exampleModal" style="float: right;">주문서
						조회</button>
					<table class="table table-hover" id="planTable">
						<thead>
							<tr>
								<th>No</th>
								<th>생산계획코드</th>
								<th>주문코드</th>
								<th>계획명</th>
								<th>담당자</th>
								<th>생산계획일자</th>

							</tr>
						</thead>
						<tbody>

							<tr th:each="plan : ${list}" th:data-plan-code="${plan.planCode}"
								class="plan-row">
								<td th:text="${planStat.count}"></td>
								<td th:text="${plan.planCode}"></td>
								<td th:text="${plan.ordCode}"></td>
								<td th:text="${plan.planTitle}"></td>
								<td th:text="${plan.planPerson}"></td>
								<td th:text="${#dates.format(plan.planDate, 'yyyy-MM-dd')}"></td>


							</tr>

						</tbody>
					</table>
				</div>
				<!-- ============================생산상세계획============================ -->

				<div class="mt-4">
					<button class="btn btn-secondary"
						style="float: right; margin: 0 5px;">저장</button>
					<table class="table table-hover" id="planDetailTable">
						<thead>
							<tr>
								
								<th>생산계획코드</th>
								<th>제품코드</th>
								<th>생산계획 시작일자</th>
								<th>생산계획 종료일자</th>
								
								<th>주문수량</th>
								<th>계획량</th>
								<th>납기/마감일자</th>
							</tr>
						</thead>
						<tbody id="planDetails">
							<th:block th:each="planD : ${dList}">
								<tr>
									<td>1</td>
									<td th:text="${planD.planCode}"></td>
									<td th:text="${planD.prodCode}"></td>
									<td><input type="date"></td>
									<td><input type="date"></td>
									<td th:text="${planD.prodCount}"></td>
									<td th:text="${planD.dplanCount}"></td>
									<td><input type="number"></td>
									<td th:text="${#dates.format(planD.dlvyDate, 'yyyy-MM-dd')}"></td>
								</tr>
							</th:block>
						</tbody>
					</table>
				</div>
				<!-- <br>
				<br>
				<div id="grid">
					<button class="btn btn-secondary"
						style="float: right; margin: 8px 5px;">저장</button>
				</div> -->

			</div>
		</div>

		<!-- <script th:inline="javascript">
			const grid = new tui.Grid({
				  el: document.getElementById('grid'), // 그리드 요소 ID가 맞는지 확인하세요
				  scrollX: false,
		            scrollY: false,
				  columns: [
				    // 데이터 구조에 따라 컬럼을 정의하세요
				    { name: 'dplanCode', header: '생산계획 코드' },
				    { name: 'planCode', header: '제품 코드' },
				    { name: '', header: '시작 일자' },
				    { name: '', header: '종료 일자' },
				    { name: 'prodCount', header: '현재 재고' },
				    { name: 'dplanCount', header: '주문 수량' },
				    { name: 'planCode', header: '계획량' },
				    { name: 'formattedDate', header: '납기 일자' },
				    // 데이터에 따라 다른 컬럼 추가
				  ],
				  // 여기에 다른 그리드 옵션을 추가할 수 있습니다
				  rowHeaders: ['checkbox','rowNum'],
	            pageOptions: {
	                useClient: true,
	                perPage: 5
	            }
				});
	
				// 행에 대한 이벤트 리스너
				document.querySelectorAll('.plan-row').forEach(row => {
				  row.addEventListener('click', function() {
				    const planCode = this.getAttribute('data-plan-code');
	
				    fetch('/planDetail?planCode=' + planCode)
				      .then(response => response.json())
				      .then(data => {
				        // Toast Grid 형식에 맞게 데이터를 수정할 필요가 있으면 수정하세요
				        const gridData = data.map(detail => {
				          // 필요하다면 데이터를 포맷팅하세요
				          const date = new Date(detail.dlvyDate);
				          detail.formattedDate = date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
				          return detail;
				        });
	
				        // Toast Grid 데이터 업데이트
				        grid.resetData(gridData);
				      });
				  });
			  });
    	</script> -->

		<script>
			let tempOrderDetails = [];
			 // 초기에 모달 창을 만들 때 테이블 헤더를 미리 추가합니다.
		    const detailsContainer = document.getElementById('orderDetails');
		    const table = document.createElement('table');
		    table.className = 'table';
	
		    const thead = document.createElement('thead');
		    thead.innerHTML = `
		        <tr>
		            <th>제품 코드</th>
		            <th>주문 수량</th>
		            <th>납기일자</th>
		        </tr>
		    `;
		    table.appendChild(thead);
	
		    detailsContainer.appendChild(table);
	
		    document.querySelectorAll('.ord-row').forEach(row => {
		        row.addEventListener('click', function() {
		            const ordCode = this.getAttribute('data-ord-code');
		            fetch('/orderDetail?ordCode=' + ordCode)
		                .then(response => response.json())
		                .then(data => {
		                	tempOrderDetails = data;
		                    // 테이블 본문을 업데이트합니다.
		                    const tbody = document.createElement('tbody');
	
		                    data.forEach(detail => {
		                        const tr = document.createElement('tr');
		                        
		                        const date = new Date(detail.dlvyDate);
		                        const formattedDate = date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
		                        
		                        tr.innerHTML = `
		                            <td>${detail.prodCode}</td>
		                            <td>${detail.ordCount}</td>
		                            <td>${formattedDate}</td>
		                            
		                        `;
		                        tbody.appendChild(tr);
		                    });
	
		                    // 기존 테이블 본문을 제거하고 새로운 테이블 본문으로 교체합니다.
		                    const existingTbody = table.querySelector('tbody');
		                    if (existingTbody) {
		                        table.removeChild(existingTbody);
		                    }
		                    table.appendChild(tbody);
		                });
		        });
		    });
		    
		    
		    
		    
		    
		    document.querySelectorAll('.plan-row').forEach(row => {
				row.addEventListener('click', function() {
					const  planCode = this.getAttribute('data-plan-code');
					
					 fetch('/planDetail?planCode=' + planCode)
						.then(response => response.json())
						.then(data => {
							const detailsTbody = document.getElementById('planDetails');
							detailsTbody.innerHTML = ''; // 기존 내용 초기화
			
							// 상세 정보 리스트를 반복하여 tr 요소 생성 및 추가
							data.forEach(detail => {
								const tr = document.createElement('tr');
								const date = new Date(detail.dlvyDate);
		                        const formattedDate = date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
								console.log(detail);
								tr.innerHTML = `
									<td>${detail.dplanCode}</td>
		                            <td>${detail.planCode}</td>
		                            <td>${detail.prodCode}</td>
		                            <td><input type="date"></td>
		                            <td><input type="date"></td>
		                            <td>${detail.prodCount}</td>
		                            <td>${detail.dplanCount}</td>
		                            <td><input type="number"></td>
		                            <td>${formattedDate}</td>
								`;
								detailsTbody.appendChild(tr);
							});
						});
				});
			}); 
		    
		    
		    
		    //모달 추가 버튼
		    document.getElementById('addPlanBtn').addEventListener('click', function() {
		        var selectedRadio = document.querySelector('input[name="flexRadioDefault"]:checked');
		        if (!selectedRadio) {
		            alert('주문을 선택해주세요.');
		            return;
		        }

		        var ordCode = selectedRadio.id;
		        
		                // 서버로부터 받은 데이터를 사용하여 테이블에 행 추가
		                var planTable = document.getElementById('planTable');
		                var newRow = planTable.insertRow(-1);
		                newRow.className = "plan-row new-row";
		                
		                var newNo = planTable.rows.length;

		                var cell1 = newRow.insertCell(0);
		                var cell2 = newRow.insertCell(1);
		                var cell3 = newRow.insertCell(2);
		                var cell4 = newRow.insertCell(3);
		                var cell5 = newRow.insertCell(4);
		                var cell6 = newRow.insertCell(5);
		                
		                var planTitleInput = document.createElement('input');
		                planTitleInput.type = 'text'
		                
		                var dateInput = document.createElement('input');
		                dateInput.type = 'date'
		                var today = new Date();
		                var dd = String(today.getDate()).padStart(2, '0');
		                var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
		                var yyyy = today.getFullYear();

		                today = yyyy + '-' + mm + '-' + dd;
		                dateInput.value = today;
		                // ... 추가 셀 생성 및 데이터 설정

		                cell1.innerHTML = newNo - 1; // 서버로부터 받은 데이터 사용
		                cell2.innerHTML = '';
		                cell3.innerHTML = ordCode;
		                cell4.appendChild(planTitleInput);
		                cell5.innerHTML = '조익수';
		                cell6.appendChild(dateInput);
		                
		                
		                
		                
		                var planDetailTable = document.getElementById('planDetailTable');
		                tempOrderDetails.forEach((detail, index) => {
		                    const date = new Date(detail.dlvyDate);
		                    const formattedDate = date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
		                    var newRow = planDetailTable.insertRow();
		                    newRow.className = "plan-detail-row"; // 행에 클래스 추가

		                    // 각 셀에 데이터 삽입
		                    newRow.innerHTML = `
		                        <td></td>
		                        <td>${detail.prodCode}</td>
		                        <td><input type="date" name="startDate" ></td>
		                        <td><input type="date" name="endDate" ></td>
		                        <td>${detail.ordCount}</td>
		                        <td><input type="number" name="planCount" value="${detail.planCount || ''}"></td>
		                        <td>${formattedDate}</td>
		                    `;
		                });
		                
		                // 모달 닫기
		                var exampleModal = document.getElementById('exampleModal');
		                var modal = bootstrap.Modal.getInstance(exampleModal);
		                modal.hide();
		           
		    });
		    
		    
		    
		    //insert
		    document.querySelector('#planInsert').addEventListener('click', function() {
		        // 'new-row' 클래스를 가진 행들만 선택
		        var newPlanRows = document.querySelectorAll('#planTable .new-row');

		        var planData = Array.from(newPlanRows).map(row => {
		            return {
		                
		            	ordCode: row.querySelector('td:nth-child(3)').innerText,
		                planTitle: row.querySelector('td:nth-child(4) input').value, // input 요소의 value 속성 사용
		                planPerson: row.querySelector('td:nth-child(5)').innerText,
		                planDate: row.querySelector('td:nth-child(6) input').value // input 요소의 value 속성 사용
		            };
		        });
		        
		        var newPlanDetailRows = document.querySelectorAll('#planDetailTable .plan-detail-row');
				console.log("planDetailTable : ", planDetailTable);
		        console.log("Total rows found:", newPlanDetailRows.length); // 찾은 행의 수를 로깅
				console.log("newPlanDetailRows : ",newPlanDetailRows);
				
		        var planDetailData = Array.from(newPlanDetailRows).map(row => {
		            console.log("Current row:", row); // 현재 행 로깅

		            // 각 셀의 데이터 추출
		            var prodCode = row.cells[2].innerText;
		            console.log("prodCode : ", prodCode);
		            var dPlanStartDate = row.cells[3].querySelector('input').value;
		            var dPlanEndDate = row.cells[4].querySelector('input').value;
		            // ... 나머지 데이터 추출

		            console.log("Extracted data:", { prodCode, dPlanStartDate, dPlanEndDate }); // 추출된 데이터 로깅

		            return { prodCode, dPlanStartDate, dPlanEndDate }; // 데이터 반환
		        });

		        console.log("Collected detail data:", planDetailData);
		        
		        console.log(planData);
		        
		        
		        console.log(planDetailData);
		        
		        
		        
		        // AJAX 요청으로 서버에 데이터 전송
		        fetch('/planInsert', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                
		            },
		            body: JSON.stringify({ planData, planDetailData })
		        })
		        .then(response => {
		            if (!response.ok) {
		                throw new Error('Network response was not ok');
		            }
		            return response.json();
		        })
		        .then(data => {
		            console.log('Success:', data);
		            window.location.href = 'planManage'; // 성공적으로 처리된 후 리디렉트
		        })
		        .catch(error => {
		            console.error('Error:', error);
		        });
		        
		        
		        
		    });
		   
		</script>
	</section>

</body>
</html>